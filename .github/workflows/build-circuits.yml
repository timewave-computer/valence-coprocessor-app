name: build circuits

on:
  push:
    branches: main
  pull_request:
    branches: main

jobs:
  build:
    name: >
      ${{ matrix.os }}
      ${{ matrix.docker && 'with docker' || 'without docker' }}
      ${{ matrix.nix && 'with nix' || 'without nix' }}
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ "macos-13", "ubuntu-latest" ]
        nix: [ true, false ]
        docker: [ true, false ]
        exclude:
          # Won't work, either nix or docker is needed
          - nix: false
            docker: false
          # podman doesn't work on macos github runner image
          - nix: true
            docker: false
            os: macos-13
          # unnecessary, only nix is used on x86_64-linux even if docker is available
          - nix: true
            docker: true
            os: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Install nix
        if: matrix.nix
        uses: nixbuild/nix-quick-install-action@v32
      - uses: mathio/gha-cleanup@v1
        with:
          remove-browsers: true
      - name: Set up Docker
        if: ${{ matrix.os == 'macos-13' && matrix.docker }}
        uses: docker/setup-docker-action@v4
        env:
          LIMA_START_ARGS: --cpus 4 --memory 8
      - name: Remove docker
        if: ${{ ! matrix.docker }}
        run: sudo rm -f $(which docker)
      - name: Build circuits
        run: ./build-circuits.sh
        env:
          NIX_ARGS: "-vL"
